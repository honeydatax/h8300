' Gambas class file

Public com As Gaqmes[]
Public idxss As Integer
Public Clients As Object[]
Public Srv As ServerSocket
Public Tport As Integer = 8080
Public Sub Socket_Read()
  Dim com1 As Gaqmes
  Dim sep As String[]
  Dim lists As String[]
  Dim kl As String
  Dim ee As Integer
  Dim vv As String
  Dim vvv As String
  Dim v As String
  Dim i As Integer
  Dim ii As Integer
  Dim scad As String
  com1 = New Gaqmes
  If idxss > 32000 Then idxss = 1
  ee = 0
  Read #Last, scad, Lof(Last)
    
  i = InStr(scad, "\n")
  If i < 1 Then Error.Raise("error\r\n")  
  vvv = Mid(scad, i + 1)
  i = InStr(scad, "GET /")
  If i < 1 Then Error.Raise("error")
  i = InStr(scad, "HTTP/1.")
  If i < 1 Then Error.Raise("error")
  scad = Replace(scad, "GET ", "") 
  scad = Replace(scad, "HTTP/1.", "")
  i = InStr(scad, "/")
  If i < 1 Then
      Error.Raise("error")
    Else
      scad = Mid(scad, i)
  Endif
  i = InStr(scad, " ")
  If i < 1 Then
      Error.Raise("error")
    Else
      scad = Mid(scad, 1, i - 1)
  Endif
 
  
  ee = 1 
  v = ""
  scad = Replace(scad, "/", "")
  scad = Trim(scad)
  Print Time(); ":"; scad
   If scad = "" Then 
     idxss = idxss + 1
     com.Add(com1)
     i = com.count - 1
     Print i
     com[i].idxss = Trim(Str(idxss))
     com[i].number = Rnd() * 99 + 1
     com[i].overs = 0
     com[i].tryss = 0
     v = Trim(Str(idxss)) & "," & 0 & ",Guess a number from 0 to 100?"
     Else
       sep = Split(scad, ",")
       For i = 0 To com.count
         If com[i].idxss = Trim(sep[0]) Then
            If Val(sep[1]) < com[i].number Then
             v = Trim(sep[0]) & "," & 0 & ",the number is big in trys:" & com[i].tryss
           End If
           If Val(sep[1]) > com[i].number Then
             v = Trim(sep[0]) & "," & 0 & ",the number is less in trys:" & com[i].tryss
           End If
           com[i].tryss = com[i].tryss + 1
           If Val(sep[1]) = com[i].number Then
             v = Trim(sep[0]) & "," & 1 & ",Guess the number in trys:" & com[i].tryss
             com.Remove(i)
            End If 
            
         i = 32032
         End If
       Next
   Endif
ee = 0
   
   Write #Last, v, Len(v)
   Close #Last
   Finally 
    If ee = 1 Then
    Close Last
    End If
  Catch 
 'Write #Last, "error\r\n", 9
End
Public Sub Socket_closed()
  Print "closed..."
  Clients.Remove(Clients.Find(Last))  
End
Public Sub Srv_Connection(Host As String)
  Dim mysock As Socket
  Print Host
      mysock = Srv.Accept()
      Clients.Add(mysock)     
End
Public Sub _New()
  Clients = New Object[]
  com = New Gaqmes[]
  Srv = New ServerSocket As "Srv"
  idxss = 0
  Srv.Port = Tport
  Srv.Type = Net.Internet
  Srv.Listen()
End
